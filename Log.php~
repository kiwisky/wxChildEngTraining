<?php defined('SYSPATH') OR die('No direct access allowed.');
/**
 * Help class for Log class
 * @file Log.php
 * @package Essentris
 * @category Library
 * @see Log
 * @author Peng Zhu
 * @copyright (C) 2013 by CliniComp International
 */
class Cci_LogLevel
{
    const DISABLE = 0;
    const ERROR = 1;
    const WARNING = 2;
    const INFO = 3;
    const DEBUG = 4;
    public static function getName($level) {
        switch ($level) {
            case 0: return 'DISABLE';
            case 1: return 'ERROR';
            case 2: return 'WARNING';
            case 3: return 'INFO';
            case 4: return 'DEBUG';
            default: return 'UNKNOWN';
        }
    }
}
/**
 * CCI Log utility
 * @package Essentris
 * @category Library
 * @author Peng Zhu
 * @copyright (C) 2013 by CliniComp International
 */
class Cci_Log
{
    public static $LOG_LEVEL = 0;
    public static $LOG_FILE = '';
    public static function INIT() {
        if (defined('CCI_APP_LOG_FILE')) {
            self::$LOG_LEVEL = Cci_LogLevel::DEBUG;  // default log_level
            self::$LOG_FILE = CCI_APP_LOG_FILE;
        }
    }
    /**
     * Write log files to $LOG_FILE
     */
    static private function logging($msg, $name = NULL)
    {
        $currTime = strftime("%b %d %Y %X", time());
        $file = fopen($name, "a+");
        if (flock($file, LOCK_EX)) {
            fwrite($file, $currTime . ":" . $msg . "\n");
            flock($file, LOCK_UN);
        }
        fclose($file);
    }
    /**
     * Mapping from PHP's errors into our logging levels
     */
    public static $ERROR_CODE_TO_LOG_LEVEL = NULL;
    /**
     * Implementation of logging, the warn, info, debug, error functions call this.
     * @param string $msg The message to be logged.
     * @param mixed $data An object to logged. For the server logs, it will be printed using var_export();
     * @param LogLevel $level The level of the logging call. If the current level is lower than this level, this call will be ignored
     * @param string $file File that sent the message. Use __FILE__ to pass this in.
     * @param string $line Line number that message was sent from. Use __LINE__ to pass this in.
     */
    static public function logMsg($msg, $data, $level, $file = NULL, $line = NULL)
    {
        if (self::$LOG_LEVEL <= 0 || self::$LOG_LEVEL < $level) {
            return;
        }
        self::logMsgEx($msg, $data, $level, $file, $line, static::$LOG_FILE);
    }
    static public function logMsgEx($msg, $data, $level, $file, $line, $name) {
        // The message prefix including $file and $line information
        $msgPrefix = getmypid() . ": ";
        if (!is_null($file)) {
            $msgPrefix .= basename($file) . ": ";
        }
        if (!is_null($line)) {
            $msgPrefix .= $line . ": ";
        }
        // The full message to be logged to a file, need to convert $data into a string
        $logMessage = $msgPrefix . $msg;
        if (!is_null($data)) {
            if (is_string($data)) {
                $logMessage .= ":" . $data;
            } else {
                $logMessage .= ":" . var_export($data, true);
            }
        }
        self::logging(Cci_LogLevel::getName($level) . ":" . $logMessage, $name);
    }
    /**
     * Convenience function for logging messages of level INFO
     * @static
     * @param string $msg Message to be sent
     * @param mixed $data variable to be analyzed
     *
     * @param string $file file where message was sent from
     * @param int $line line number where message was sent from
     * @return void
     */
    static public function info($msg, $data = NULL, $file = NULL, $line = NULL) {
        self::logMsg($msg, $data, Cci_LogLevel::INFO, $file, $line);
    }
    /**
     * Convenience function for logging messages of level DEBUG
     * @static
     * @param string $msg Message to be sent
     * @param mixed $data variable to be analyzed
     * @param string $file file where message was sent from
     * @param int $line line number where message was sent from
     * @return void
     */
    static public function debug($msg, $data = NULL, $file = NULL, $line = NULL) {
        self::logMsg($msg, $data, Cci_LogLevel::DEBUG, $file, $line);
    }
   
    /**
     * Convenience function for logging messages of level ERROR
     * @static
     * @param string $msg Message to be sent
     * @param mixed $data variable to be analyzed
     * @param string $file file where message was sent from
     * @param int $line line number where message was sent from
     * @return void
     */
    static public function error($msg, $data = NULL, $file = NULL, $line = NULL) {
        self::logMsg($msg, $data, Cci_LogLevel::ERROR, $file, $line);
    }
    /**
     * Convenience function for logging messages of level WARNING
     * @static
     * @param string $msg Message to be sent
     * @param mixed $data variable to be analyzed
     * @param string $file file where message was sent from
     * @param int $line line number where message was sent from
     * @return void
     */
    static public function warn($msg, $data = NULL, $file = NULL, $line = NULL) {
        self::logMsg($msg, $data, Cci_LogLevel::WARNING, $file, $line);
    }
}
// Should be initialized in the class, but php doesn't allow initializing static members to an expression
Cci_Log::$ERROR_CODE_TO_LOG_LEVEL = array(
    E_ERROR => Cci_LogLevel::ERROR,
    E_WARNING => Cci_LogLevel::WARNING,
    E_PARSE => Cci_LogLevel::ERROR,
    E_NOTICE => Cci_LogLevel::INFO,
    E_CORE_ERROR => Cci_LogLevel::ERROR,
    E_CORE_WARNING => Cci_LogLevel::WARNING,
    E_COMPILE_ERROR => Cci_LogLevel::ERROR,
    E_COMPILE_WARNING => Cci_LogLevel::WARNING,
    E_USER_ERROR => Cci_LogLevel::ERROR,
    E_USER_WARNING => Cci_LogLevel::WARNING,
    E_USER_NOTICE => Cci_LogLevel::INFO,
    E_STRICT => Cci_LogLevel::WARNING
);
Cci_Log::INIT();
?>

